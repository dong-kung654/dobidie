<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>무기</title>
    <style>
        /* 기존 스타일 유지 */
        .result-box {
            border: 1px solid #ccc;
            padding: 6px;
            margin: 6px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .result-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .result-info {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .result-info div {
            width: calc(20% - 6px); 
            box-sizing: border-box;
        }

        .result-info.full-info {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .result-info.full-info div {
            width: calc(25% - 6px);
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .result-info div {
                width: calc(50% - 6px);
            }
            .result-info.full-info div {
                width: calc(50% - 6px);
            }
        }   

        @media (max-width: 480px) {
            .result-info div {
                width: 100%;
            }
            .result-info.full-info div {
                width: 100%;
            }
        }

        #searchBox {
            width: 80%;
            padding: 10px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #searchButton {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #searchButton:hover {
            background-color: #45a049;
        }

        .search-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>무기</h1>
    
    <div class="search-container">
        <input type="text" id="searchBox" placeholder="검색어를 입력하세요..." />
        <button id="searchButton">검색</button>
    </div>

    <div id="results"></div>

    <script>
        // 서버에서 불러올 파일의 경로
        const files = {
            "weapon": "/assets/weapon.json"
        };

        // 검색 함수
        async function search() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';  // 이전 검색 결과 초기화

            if (!query) {
                alert("검색어를 입력해주세요.");
                return;
            }

            try {
                const data = await Promise.all(Object.values(files).map(file => fetchData(file)));
                const [weaponData] = data;

                // 검색어로 무기 필터링
                const filteredWeapons = weaponData.filter(weapon => weapon.name.toLowerCase().includes(query));
                if (filteredWeapons.length === 0) {
                    resultsContainer.innerHTML = "<p>검색 결과가 없습니다.</p>";
                    return;
                }

                // 결과 표시
                filteredWeapons.forEach(weapon => displayResult(weapon));
            } catch (error) {
                console.error("데이터를 가져오는 중 오류가 발생했습니다:", error);
            }
        }

        // 파일 데이터를 fetch하는 함수
        async function fetchData(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`네트워크 응답이 정상이 아닙니다. 상태 코드: ${response.status}`);
            }
            return await response.json();
        }


            // 직업 사용 가능 여부를 판단하는 함수
        function getUsableJobs(weapon) {
            const jobs = {
                "군": weapon.use_royal,
                "기": weapon.use_knight,
                "법": weapon.use_mage,
                "엘": weapon.use_elf,
                "다": weapon.use_darkelf,
                "용": weapon.use_dragonknight,
                "환": weapon.use_blackwizard,
                "전": weapon.use_warrior
                };
            // 모든 직업이 사용 가능하면 "전직업 사용 가능" 표시
            if (Object.values(jobs).every(v => v === 1)) {
                return "전직업 사용 가능";
            }

            // 사용 가능한 직업만 나열
            const usableJobs = Object.entries(jobs)
                .filter(([job, canUse]) => canUse === 1)
                .map(([job]) => job);

            return usableJobs.length > 0 ? usableJobs.join(", ") : "사용 불가";
            }

        function getStats(weapon) {
             // 스텟 항목들을 객체로 묶음
            const stats = {
                "힘": weapon.add_str,
                "콘": weapon.add_con,
                "민": weapon.add_dex,
                "인": weapon.add_int,
                "위": weapon.add_wis,
                "카": weapon.add_cha
            };

            // 모든 스텟이 동일한지 체크 (0이나 undefined가 아닌 값들만 체크)
            const statValues = Object.values(stats);
            const uniqueValues = [...new Set(statValues.filter(v => v !== undefined && v !== 0))];

            // 모든 스텟이 동일하면 "모든 스텟 : 값" 표시
            if (uniqueValues.length === 1 && statValues.length === statValues.filter(v => v !== undefined && v !== 0).length) {
                return `모든 스텟 : ${uniqueValues[0]}`;
            }

            // 개별적으로 표시할 경우 (0이 아닌 값만 필터링)
            const statList = Object.entries(stats)
                .filter(([_, value]) => value !== undefined && value !== 0) // 0이나 undefined가 아닌 값만
                .map(([key, value]) => `${key} ${value}`);

            return statList.length > 0 ? statList.join(", ") : "";
        }

        // 조건에 맞는 항목만 표시하는 함수
        function displayConditionally(label, value) {
            if (value && value !== 0) {
                return `<div style="display:block;"><strong>${label}:</strong> ${value}</div>`;
            }
            return '';  // 값이 없거나 0이면 해당 항목을 아예 반환하지 않음
        }

        // 검색 결과 표시 함수 (무기 항목을 출력하도록 수정)
        function displayResult(weapon) {
            const resultsContainer = document.getElementById('results');
            const resultBox = document.createElement('div');
            resultBox.className = 'result-box';

            // 무기 항목들을 표시
            const weaponInfo = `
                <div class="result-title">${weapon.name}</div>
                <div class="result-info">
                    <div><strong>아이템 ID:</strong> ${weapon.item_id || '없음'}</div>
                    <div><strong>종류:</strong> ${weapon.type || '없음'}</div>
                    <div><strong>재질:</strong> ${weapon.material || '없음'}</div>
                    <div><strong>무게:</strong> ${weapon.weight/1000 || '없음'}</div>
                    <div><strong>작은 몹:</strong> ${weapon.dmg_small || '없음'}</div>
                    <div><strong>큰 몹:</strong> ${weapon.dmg_large || '없음'}</div>
                    <div><strong>안전인첸:</strong> ${weapon.safenchant || '없음'}</div>
                    <div><strong>착용 직업:</strong> ${getUsableJobs(weapon)}</div>
                </div>  
                <div class="result-info">
                    <div><strong>헤이스트:</strong> ${weapon.haste_item ? '있음' : '없음'}</div>
                    <div><strong>손상:</strong> ${weapon.canbedmg ? '가능' : '불가'}</div>
                    <div><strong>축복:</strong> ${weapon.bless ? '있음' : '없음'}</div>
                    <div><strong>거래 가능:</strong> ${weapon.trade ? '가능' : '불가'}</div>
                    <div><strong>삭제 불가:</strong> ${weapon.cant_delete ? '불가' : '가능'}</div>
                </div>
            
            `;
            const fullInfo = `
                <div class="result-info full-info">
                    ${displayConditionally("hp 증가", weapon.add_hp)}
                    ${displayConditionally("hp 회복", weapon.add_hpr)}
                    ${displayConditionally("MP 추가", weapon.add_mp)}
                    ${displayConditionally("MP 회복", weapon.add_mpr)}
                    ${displayConditionally("sp 증가", weapon.add_sp)}
                    ${displayConditionally("추가 데미지", weapon.dmgmodifier)}
                    ${displayConditionally("추가명중", weapon.hitmodifier)}
                    ${displayConditionally("마법피해", weapon.magicdmgmodifier)}
                    ${displayConditionally("마법방어", weapon.m_def)}
                    ${displayConditionally("더블찬스", weapon.double_dmg_chance)}
                    ${displayConditionally("최소레벨", weapon.min_lvl)}
                    ${displayConditionally("최대레벨", weapon.max_lvl)}
                    ${displayConditionally("사용시간", weapon.max_use_time)}
                    ${getStats(weapon)}
                </div>
            `;
            const fullInfo1 = `
                <div class="result-info full-info">
                    ${displayConditionally("원거리 크리", weapon.missile_critical_probability)}
                    ${displayConditionally("근거리 크리", weapon.melee_critical_probability)}
                    ${displayConditionally("마법 적중", weapon.magic_hit_up)}
                    ${displayConditionally("마법 이름", weapon.Magic_name)}
                </div>
            `;

            resultBox.innerHTML = weaponInfo + fullInfo + fullInfo1;
            resultsContainer.appendChild(resultBox);
        }

        // 검색 버튼 클릭 시 검색 실행
        document.getElementById('searchButton').addEventListener('click', search);
    </script>
</body>
</html>
